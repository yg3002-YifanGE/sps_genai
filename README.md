# SPS GenAI ‚Äî Assignment 1 & 2

Course: *Applied Generative AI*  
Student: **Yifan Ge (yg3002)**

This repository includes:
- **Assignment 1** ‚Äì Coding environment setup + a simple FastAPI service (Bigram LM, embeddings, similarity)
- **Assignment 2** ‚Äì CIFAR-10 CNN classifier + an online prediction endpoint built into the same FastAPI app

---

## üì¶ Features

### Assignment 1
- **Bigram Language Model** ‚Äì `POST /generate`  
  Generates text using bigram probabilities.
- **Word Embeddings** ‚Äì `POST /embed`  
  Returns the spaCy `en_core_web_md` embedding vector for an input token.
- **Word Similarity** ‚Äì `POST /similar`  
  Finds top-k most similar tokens via cosine similarity in the embedding space.
- **FastAPI** (optionally Dockerized) for a reproducible API.

### Assignment 2
- **CNN_A2 (64√ó64√ó3) for CIFAR-10**  
  `Conv(3‚Üí16,k3,s1,p1) ‚Üí ReLU ‚Üí MaxPool(2)` ‚Üí  
  `Conv(16‚Üí32,k3,s1,p1) ‚Üí ReLU ‚Üí MaxPool(2)` ‚Üí  
  `Flatten(32√ó16√ó16)` ‚Üí `FC(8192‚Üí100)` ‚Üí ReLU ‚Üí `FC(100‚Üí10)`
- **Training script** ‚Äì `assignment2.py` (train ‚Üí evaluate ‚Üí save weights).  
  Baseline: 5 epochs, Adam(lr=1e-3), batch size 128 ‚Üí **~66%** test accuracy.
- **Prediction endpoint** ‚Äì `POST /predict_cifar10`  
  Upload an RGB image; returns the predicted label and softmax probabilities.

---

## üóÇÔ∏è Repository Structure

```text
sps_genai/
‚îú‚îÄ app/
‚îÇ  ‚îú‚îÄ __init__.py
‚îÇ  ‚îî‚îÄ main.py                  # FastAPI app (A1 endpoints + A2 /predict_cifar10)
‚îú‚îÄ helper_lib/
‚îÇ  ‚îú‚îÄ __init__.py
‚îÇ  ‚îú‚îÄ model.py                 # includes CNN_A2 (+ VAE from class activity)
‚îÇ  ‚îú‚îÄ trainer.py               # train_model / train_vae_model
‚îÇ  ‚îî‚îÄ data_loader.py           # MNIST + CIFAR-10 loaders (optional resize‚Üí64√ó64)
‚îú‚îÄ assignment2.py              # Train/eval/save weights (A2 Part 1)
‚îú‚îÄ assignment2/
‚îÇ  ‚îî‚îÄ cnn_a2_cifar10.pt        # Saved weights (generated by training)
‚îú‚îÄ module5_class_activity.ipynb  # VAE activity (optional)
‚îî‚îÄ README.md
```
> Don‚Äôt want to push weights? Add to `.gitignore`:
> ```gitignore
> assignment2/*.pt
> ```

---

## üß∞ Environment Setup

> Tested on Python 3.11/3.12, torch 2.2.x, torchvision 0.17.x.  
> If you hit NumPy 2.x compatibility issues, pin NumPy `< 2`.

```bash
conda create -n a2 python=3.11 -y
conda activate a2

# Core deps (pin NumPy<2 for PyTorch 2.2.x)
python -m pip install "numpy==1.26.4" torch==2.2.2 torchvision==0.17.2 pillow

# API deps
python -m pip install "fastapi>=0.110" "uvicorn[standard]" python-multipart

# Assignment 1 embedding/semantic endpoints
python -m pip install spacy
python -m spacy download en_core_web_md
```

---

## üèãÔ∏è Train (Assignment 2 ‚Äì Part 1)

Train CNN_A2 on CIFAR-10 (resized to 64√ó64), evaluate, and save weights.

```bash
cd sps_genai
python assignment2.py
# Example:
# Epoch 1/5 ...
# Test Accuracy: 66.2800%
# Saved weights to assignment2/cnn_a2_cifar10.pt
```

---

## üåê Run API (Assignment 2 ‚Äì Part 2)

Start the FastAPI service (includes A1 endpoints and A2 `/predict_cifar10`):

```bash
# IMPORTANT: start from project root so `app` is recognized as a package
cd sps_genai
python -m uvicorn app.main:app --reload

# Swagger UI
# http://127.0.0.1:8000/docs
```

### `/predict_cifar10` (POST multipart/form-data)
- **Body**: `file` (image, jpg/png)  
- **Returns**:  
  - `pred_id` (0‚Äì9)  
  - `pred_label` (`airplane`/`automobile`/`bird`/`cat`/`deer`/`dog`/`frog`/`horse`/`ship`/`truck`)  
  - `probs` ‚Äì list of 10 softmax probabilities

**curl example**
```bash
curl -X POST "http://127.0.0.1:8000/predict_cifar10"   -H "accept: application/json"   -H "Content-Type: multipart/form-data"   -F "file=@/absolute/path/to/any_rgb_image.jpg"
```

---

## üê≥ (Optional) Docker (Assignment 1)

Build & run the A1 service.  
To include A2, extend the Dockerfile with `torch/torchvision`, `python-multipart`, and ensure weights
`assignment2/cnn_a2_cifar10.pt` are copied or mounted into the container.

```bash
docker build -t sps-genai .
docker run --name sps-genai -p 8000:80 sps-genai
# Root: http://127.0.0.1:8000/   Docs: http://127.0.0.1:8000/docs
```

---

## üìà Tips to Improve Accuracy (A2)

- Train longer: 20‚Äì40 epochs  
- Augmentation: `RandomCrop(64, padding=4)` + `RandomHorizontalFlip`  
- Regularization: `weight_decay=1e-4`  
- LR schedule: `StepLR(step_size=15, gamma=0.1)`  
- Batch size: 128‚Äì256 (depending on memory)

---

## üõ†Ô∏è Troubleshooting

- **NumPy 2.x error** (`_ARRAY_API not found` / ‚ÄúNumpy is not available‚Äù):
  ```bash
  python -m pip uninstall -y numpy
  python -m pip install "numpy==1.26.4"
  # (optional) relink PyTorch stack:
  python -m pip install --upgrade --force-reinstall torch==2.2.2 torchvision==0.17.2
  ```
- **ModuleNotFoundError: app**  
  Start from project root: `python -m uvicorn app.main:app --reload` and ensure `app/__init__.py` exists.
- **Uvicorn not found**  
  `python -m pip install "uvicorn[standard]"`.
- **SpaCy model missing**  
  `python -m spacy download en_core_web_md`.
- **Weights not found**  
  Ensure `assignment2/cnn_a2_cifar10.pt` exists (run training first) and the path matches what `app/main.py` expects.

---

## üîó Publish to GitHub

If your repo is already connected:
```bash
git add README.md app/main.py helper_lib/*.py assignment2.py assignment2/cnn_a2_cifar10.pt
git commit -m "Assignment 2: CNN_A2 + CIFAR-10 API + README"
git push
```

Initialize & push (for a brand-new repo):
```bash
git init
git add .
git commit -m "Initial commit: Assignment 1 & 2"
git branch -M main
git remote add origin https://github.com/<your-username>/<your-repo>.git
git push -u origin main
```
